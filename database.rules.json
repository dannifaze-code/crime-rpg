{
  "rules": {

    // ── Game Configuration (admin-only writes) ──
    "gameConfig": {
      ".read": true,
      ".write": "auth.uid === '7YqmKiUM9KdtxCIQsET14KWlK2K2'"
    },

    // ── User Game Data ──
    // Each user can only read/write their own data.
    // Validates top-level structure and key player fields with anti-cheat bounds.
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "email": {
          ".validate": "newData.isString() && newData.val().length < 255"
        },
        "displayName": {
          ".validate": "newData.isString() && newData.val().length < 100"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "lastLogin": {
          ".validate": "newData.isNumber()"
        },
        "lastSave": {
          ".validate": "newData.isNumber()"
        },
        "gameState": {
          ".validate": "newData.hasChildren(['player', 'character'])",
          "player": {
            ".validate": "newData.hasChildren(['name', 'level', 'cash'])",
            "name": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
            },
            "level": {
              ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 200"
            },
            "cash": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 999999999"
            },
            "xp": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "reputation": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 999999999"
            },
            "heat": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
            },
            "globalHeat": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
            }
          }
        }
      }
    },

    // ── Cloud Backups ──
    // Each user can only read/write their own backups.
    "userBackups": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "latest": {
          ".validate": "newData.hasChildren(['timestamp', 'gameState'])",
          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "reason": {
            ".validate": "newData.isString() && newData.val().length < 50"
          },
          "playerName": {
            ".validate": "newData.isString() && newData.val().length <= 50"
          },
          "playerLevel": {
            ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 200"
          },
          "playerCash": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        }
      }
    },

    // ── Leaderboard ──
    // Readable by all (public leaderboard).
    // Writable only by the player whose accountId matches the key AND auth.uid.
    // Enforces data types and anti-cheat bounds on all fields.
    "leaderboard": {
      ".read": true,
      "$accountId": {
        ".write": "auth != null && $accountId === auth.uid",
        ".validate": "newData.hasChildren(['accountId', 'username', 'level', 'cash', 'reputation', 'heat', 'status', 'lastUpdated'])",
        "accountId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "username": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
        },
        "level": {
          ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 200"
        },
        "cash": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 999999999"
        },
        "reputation": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 999999999"
        },
        "heat": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 100"
        },
        "lastKnownZone": {
          ".validate": "newData.isString() && newData.val().length <= 100"
        },
        "status": {
          ".validate": "newData.isString() && (newData.val() === 'laying_low' || newData.val() === 'active')"
        },
        "lastUpdated": {
          ".validate": "newData.isNumber()"
        },
        "$other": {
          ".validate": false
        }
      }
    },

    // ── Global Chat ──
    // Readable by all, writable by authenticated users.
    // Validates message structure, enforces 500-char limit, and ensures
    // senderId matches the authenticated user (prevents impersonation).
    "global_chat": {
      ".read": true,
      "$messageId": {
        ".write": "auth != null",
        ".validate": "newData.hasChildren(['senderId', 'senderName', 'message', 'timestamp'])",
        "senderId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "senderName": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
        },
        "message": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
        },
        "timestamp": {
          ".validate": "newData.isNumber()"
        },
        "$other": {
          ".validate": false
        }
      }
    },

    // ── Private Chats ──
    // Chat IDs are formatted as "uid1_uid2" (sorted).
    // Only participants (whose UID is in the chatId) can read or write.
    // Same message validation as global chat.
    "private_chats": {
      "$chatId": {
        ".read": "auth != null && $chatId.contains(auth.uid)",
        ".write": "auth != null && $chatId.contains(auth.uid)",
        "$messageId": {
          ".validate": "newData.hasChildren(['senderId', 'senderName', 'message', 'timestamp'])",
          "senderId": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "senderName": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
          },
          "message": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 500"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "$other": {
            ".validate": false
          }
        }
      }
    },

    // ── User Chat Index ──
    // Tracks which private chats each user is part of.
    // Users can read their own index. Any chat participant can register the chat.
    "userChats": {
      "$uid": {
        ".read": "$uid === auth.uid",
        "$chatId": {
          ".write": "auth != null && $chatId.contains(auth.uid) && $chatId.contains($uid)",
          ".validate": "newData.isBoolean() && newData.val() === true"
        }
      }
    }
  }
}
